rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check if user has a specific permission
    function hasPermission(permission) {
      return isAuthenticated() && (
        isAdmin() || 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions[permission] == true
      );
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read users (for assignment dropdown)
      allow read: if isAuthenticated();
      
      // Users can only be created if authenticated and same uid
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Admin can update anything; user can update own profile fields only
      allow update: if isAdmin() || (
        isOwner(userId) && 
        hasPermission('profile_management') &&
        // Only allow updating profile fields, not role or permissions
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'permissions'])
      );
      
      // No one can delete users from client
      allow delete: if false;
    }
    
    // Cases collection
    match /cases/{caseId} {
      // Read: admin or users with view_cases permission
      allow read: if hasPermission('view_cases');
      
      // Create: admin or users with create_case permission
      allow create: if hasPermission('create_case');
      
      // Update: admin full access, or specific permission-based updates
      allow update: if isAdmin() || (
        // edit_own_cases: only creator, only title/description
        (hasPermission('edit_own_cases') && 
         resource.data.createdBy == request.auth.uid &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'priority', 'assignedTo', 'assignedToName', 'createdBy', 'createdByName'])) ||
        // assign_to_self: only if currently unassigned
        (hasPermission('assign_to_self') && 
         resource.data.assignedTo == null &&
         request.resource.data.assignedTo == request.auth.uid) ||
        // watch_case: only watchers array
        (hasPermission('watch_case') && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['watchers']))
      );
      
      // Only admin can delete cases
      allow delete: if isAdmin();
      
      // Comments subcollection
      match /comments/{commentId} {
        // Read: admin or users with view_cases permission
        allow read: if hasPermission('view_cases');
        
        // Create: admin or users with comment_on_cases permission
        allow create: if hasPermission('comment_on_cases') && 
          request.resource.data.authorId == request.auth.uid;
        
        // Update own comments only
        allow update: if hasPermission('comment_on_cases') && isOwner(resource.data.authorId);
        
        // Delete own comments, or admin
        allow delete: if isAdmin() || (hasPermission('comment_on_cases') && isOwner(resource.data.authorId));
      }
    }
  }
}
